<!DOCTYPE html>
<html>
    <head>
        <title>Monitoring</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Monitoring
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    
                    <div id="main-content" class="wiki-content group">
                    <p>Environment Monitoring is predominantly performed by Zabbix</p><p> </p><h2 id="Monitoring-Architecture">Architecture</h2><p> </p><p>The following diagram gives an overview of the Zabbix architecture</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/25187155/27232521.png" data-image-src="attachments/25187155/27232521.png" data-unresolved-comment-count="0" data-linked-resource-id="27232521" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2014-12-2 9:51:53.png" data-base-url="https://<confluenceurl>" data-linked-resource-content-type="image/png" data-linked-resource-container-id="25187155" data-linked-resource-container-version="58"></span></p><p> </p><p> </p><h2 id="Monitoring-MonitoringRules">Monitoring Rules</h2><p>Monitoring rules are defined in templates. Each template contains a set of Items to collect (e.g. CPU utilisation, File system utilisation for /tmp) and a set of Triggers (e.g. File system /tmp exceeds 95% utilisation). Each host or VM to be monitored is defined in Zabbix and Templates are assigned to them, to apply the monitoring rules. Where standard monitoring items are not available for particular data we want to collect, then new items can be defined in configuration files that are deployed to the VM's where this item is required and are then available to use in templates as normal. This is used for PostgresSQL monitoring for example.</p><p>Templates have been defined to monitor OS, Products and Product implementations. A template is created to monitor each product component deployed (e.g. Oracle database, ETL Controller, ETL Jobserver).  Where there are implement specifics to monitor then a seperate template is created for that. Where a webservice interface exists that can be tested then a separate template is created that will be used on the server and load balancer if applicable.</p><p>Template names follow the patterns:</p><p>      EBSA_&lt;Product Component&gt;_Template.xml</p><p>      EBSA_&lt;Specific Implementation&gt;_&lt;Product Component&gt;_Template.xml</p><p>      EBSA_Webservice_&lt;Specific Implementation&gt;_&lt;Product Component&gt;_Template.xml</p><p>The templates are detailed here :<a href="https://<confluenceurl>/display/EN/Monitoring+Templates">Monitoring Templates</a></p><p>The templates are assigned to VM's according to the following :<a href="https://<confluenceurl>/display/EN/Monitoring+Template+Deployment">Monitoring Template Deployment</a> and <a href="https://<confluenceurl>/display/EN/ST+Monitoring+Template+Deployment">ST Monitoring Template Deployment</a>. This is performed by Puppet.</p><p>Templates are stored in Stash <span class="entity-name">EBSA Tooling</span> <a href="https://<stashurl>/projects/EBSAT/repos/ebsa-middleware-components/browse" class="external-link" rel="nofollow">ebsa-middleware-components</a><span class="sep">/</span><a href="https://<stashurl>/projects/EBSAT/repos/ebsa-middleware-components/browse/zabbix" class="external-link" rel="nofollow">zabbix</a><span class="sep">/</span><a href="https://<stashurl>/projects/EBSAT/repos/ebsa-middleware-components/browse/zabbix/ServiceDescription" class="external-link" rel="nofollow">ServiceDescription</a><span class="sep">/</span><span class="sep"><a href="https://<stashurl>/projects/EBSAT/repos/ebsa-middleware-components/browse/zabbix/ServiceDescription/gen_cfg_zabbix_templates" class="external-link" rel="nofollow">gen_cfg_zabbix_templates</a>/<a href="https://<stashurl>/projects/EBSAT/repos/ebsa-middleware-components/browse/zabbix/ServiceDescription/gen_cfg_zabbix_templates/src" class="external-link" rel="nofollow">src</a>/<a href="https://<stashurl>/projects/EBSAT/repos/ebsa-middleware-components/browse/zabbix/ServiceDescription/gen_cfg_zabbix_templates/src/resources/" class="external-link" rel="nofollow">resources</a>/ and packaged into an RPM an deployed using the Zabbix API.<br /></span></p><h3 id="Monitoring-ItemandTriggerNaming">Item and Trigger Naming</h3><p>The names of Items and Triggers should be a clear and concise description of what the Item is collecting or what the Trigger means.  Keep the names of similar Items and Triggers consistent with already created Items and Triggers. For example</p><p>Items</p><p>   File System Utilisation for /usr/local/schedulers</p><p>   Number Apache httpd Processes</p><p>Triggers</p><p>   File System /u01 Utilisation High 80%</p><p>   Process httpd Down</p><p>Applications - Are used to group similar types of monitor together. Following is a list of the Application Names used.</p><p> </p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Application Name</th></tr><tr><td colspan="1" class="confluenceTd">Application Logfiles</td></tr><tr><td class="confluenceTd"><p>CPU</p></td></tr><tr><td colspan="1" class="confluenceTd">Filesystems</td></tr><tr><td colspan="1" class="confluenceTd"><p>General</p></td></tr><tr><td colspan="1" class="confluenceTd">Healthcheck</td></tr><tr><td colspan="1" class="confluenceTd">Interfaces</td></tr><tr><td colspan="1" class="confluenceTd">Java</td></tr><tr><td colspan="1" class="confluenceTd">Logfiles</td></tr><tr><td colspan="1" class="confluenceTd">Memory</td></tr><tr><td colspan="1" class="confluenceTd">OracleDB</td></tr><tr><td colspan="1" class="confluenceTd">OS</td></tr><tr><td colspan="1" class="confluenceTd">Performance</td></tr><tr><td colspan="1" class="confluenceTd">PostgreSQL</td></tr><tr><td class="confluenceTd">Processes</td></tr><tr><td class="confluenceTd"><p>Security</p></td></tr><tr><td class="confluenceTd"><p>WebServices</p></td></tr><tr><td class="confluenceTd"><p>Zabbix agent</p></td></tr><tr><td colspan="1" class="confluenceTd">Activemq Destinations</td></tr><tr><td colspan="1" class="confluenceTd">Activemq Brokers</td></tr><tr><td colspan="1" class="confluenceTd">Goldengate</td></tr></tbody></table></div><h3 id="Monitoring-Generalrulesforitemsandtriggers">General rules for items and triggers</h3><p>Frequency or delay for items should normally be a minimum of 60 seconds, though for light touch tests this can go as low as 30 seconds if there is a requirement. In general only run as frequently as needed. Some may only need to run once a day. Filesystem checks should be 300 seconds. Discovery rules 3600 seconds.</p><p>The history should be kept for a period of between 7 and 30 days.</p><p>Trend information should be kept for 365 days.</p><p>Logfile monitoring triggers should be set to expire if no errors are found for a period of time. The default for this should be 1 day, but can be less if the particular case has a specific requirement. The expiry is achieved by counting matches over a period of time using the following :</p><p>({TRIGGER.VALUE}=0 &amp; {logitem.count(1d)}&amp;gt;0) | ({TRIGGER.VALUE}=1 &amp; {logitem.nodata(1d)} = 0)</p><h3 id="Monitoring-Triggerseverities">Trigger severities</h3><p>Disaster (5) - The business service is down. Use this for reporting problems with tests that check the availability of the service, for example the WebService tests.</p><p>High (4) - Something is broken. File-system full. Process down. Server down.</p><p>Average (3) - Something is going to brake. File-system utilisation high or filling up for example.</p><p>Warning (2) - Something needs investigation, but is not expected to fail imminently. There should be a higher severity alert for this if it deteriorates.</p><p>Information (1) - Information that is useful, but needs no action. For example 'All backups completed successfully'. We should have very few if any of these. Do not use unless you have a very good reason.</p><p>For logfile monitoring the same rules apply as above, but it is recognised that the application logging errors to a file may not do it in a way that allows these rules to be implemented. If in doubt then use the 'Average (3)' severity. For logfile monitoring Warning and Information severity errors should not be used unless you have a very good reason.</p><h3 id="Monitoring-UsersandUserProfiles">Users and User Profiles</h3><div class="action-body flooded"><p>The template rpm needs also sets-up media types, which will set-up the EBSA-mail-relay (media type) using thre API.</p><p>Users are maintained via the API. A list of users with attributes in stash and deployed via puppet.</p></div><h3 id="Monitoring-Monitoringcoverage">Monitoring coverage</h3><p>The following will be monitored and alerted as a minimum.</p><h4 id="Monitoring-OperatingSystems">Operating Systems</h4><p>Filesystem utiisation exceeding 85% and 99%</p><p>Swapping due to lack of memory</p><p>CPU utilisation</p><p>Critical OS processes are running</p><p>server not contactable</p><p>High CPU utilisation</p><p>IO Wait is high</p><h4 id="Monitoring-Applications">Applications</h4><p>Critical processes are running</p><p>Critical logfile errors</p><p>Interface availability - Test interface where possible (e.g. webservice call)</p><p>High Availability configuration failover</p><p> </p><p> </p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/25187155/26248815.png" data-image-src="attachments/25187155/26248815.png" data-unresolved-comment-count="0" data-linked-resource-id="26248815" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2014-10-13 9:33:15.png" data-base-url="https://<confluenceurl>" data-linked-resource-content-type="image/png" data-linked-resource-container-id="25187155" data-linked-resource-container-version="58"></span></p><h3 id="Monitoring-WhereaMonitoringRuleCheckdoesnotexist">Where a Monitoring Rule Check does not exist</h3><p>Where an inbuilt solution for a particular monitor does not exist in Zabbix, then where are two main options to solve this. The first is to use the System Run solution, but this is a potential security risk as any command can be inserted into this check. For this reason System Run is disabled.</p><p>The second and selected option is to use User Parameters. In this solution, user defined checks can be defined in a file that is deployed to monitored servers. There are currently three User Parameter files defined for PostgreSQL, OracleDB and General. Once these files are deployed by puppet to Zabbix configuration directories on monitored servers, they become available for use in templates on those servers.</p><p>User Parameter files are stored in Stash <span class="entity-name">EBSA Tooling</span> <a href="https://<stashurl>/projects/EBSAT/repos/puppet-modules/browse" class="external-link" rel="nofollow">puppet-modules</a><span class="sep">/</span><a href="https://<stashurl>/projects/EBSAT/repos/puppet-modules/browse/modules" class="external-link" rel="nofollow">modules</a><span class="sep">/</span><a href="https://<stashurl>/projects/EBSAT/repos/puppet-modules/browse/modules/ebsa" class="external-link" rel="nofollow">ebsa</a><span class="sep">/</span><a href="https://<stashurl>/projects/EBSAT/repos/puppet-modules/browse/modules/ebsa/files" class="external-link" rel="nofollow">files</a><span class="sep">/</span><span class="stub">zabbix</span></p><h3 id="Monitoring-JavaMonitoring">Java Monitoring</h3><p>Zabbix supports probing Java Application Servers for information by the use of the Java JMX API. The Zabbix Java Gateway is a separate component provides this support. It is deployed to the Monitoring Server along with the Zabbix Monitoring Service.</p><h2 id="Monitoring-MonitoringTemplateImport">Monitoring Template Import</h2><p>Monitoring templates are deployed by an RPM package. The deployment process needs to cope with new, updated and deleted templates. Within a templates items, triggers etc. may be created, updated or deleted, which the import process must cope with. The design is documented in <a href="https://<confluenceurl>/display/EN/Monitoring+Template+Import+Process">Monitoring Template Import Process</a></p><h2 id="Monitoring-MonitoringAgentsorHosts">Monitoring Agents or Hosts</h2><p>Each monitored host and it's Zabbix Agent is defined in Hiera data and managed by Puppet using a Ruby script that calls the Zabbix JSON API. Where a Java Application Server is also to be monitored, then the connection information for this is also defined and configured in the same way.</p><h2 id="Monitoring-MonitoringTemplateAssigning">Monitoring Template Assigning</h2><p>The definition of which templates are assigned to a host (VM) is defined in Hiera data and managed by Puppet using a Ruby script that calls the Zabbix JSON API. The process needs to ensure all hosts are defined in Zabbix, add new templates to hosts and remove those no longer assigned in Heira.</p><h2 id="Monitoring-PerformanceMonitoring">Performance Monitoring</h2><p>Zabbix is used for the day to day performance monitoring, though in some cases more detailed statistics may be required (e.g. individual process statistics). For this purpose nmon will be running on every VM. The statistics will be retained on the VM for 7 days and backed up to the backup server and to ATMOS. This data will NOT be automatically presented on a web page as Zabbix does this and more detailed analysis is likely to require tailored graphing. If required the nmon output can be downloaded to a Windows client and processed using MS Excel using existing tools.</p><p>Nmon to be configured on each VM to run daily at 5 min intervals, for 24 hours and stored in /var/log/nmon (-s300 -c288 -f -t -m /var/log/nmon)</p><p>Nmon files to be deleted after 7 days</p><p>Nmon files forwarded daily to backup server by backup solution.</p><p>Nmon process to be monitored on all hosts in Zabbix.</p><h2 id="Monitoring-DashboardMonitoring">Dashboard Monitoring</h2><p>Dashboard monitoring technical design is described here: <a href="https://<confluenceurl>/pages/viewpage.action?pageId=31202984">Monitoring Dashboard design (Zabbix)</a></p><p>The business functional design is here: <a href="https://<confluenceurl>/display/EN/Release+2+Dashboard">Release 2 Dashboard</a></p><p> </p><h2 id="Monitoring-Zabbixtuning">Zabbix tuning</h2><p>Some considerations for Zabbix performance.</p><p>1) As per guidlines above, don't run items with collection frequencies more often than needed.</p><p>2) Make sure the database is performing. With Postgres the main consideration is ensure the Checkpoint Frequency is not too often.  There is a check for this in the Postgres monitoring. Increase the checkpoint_segments if an alert is raised for this.</p><p>3) Increase CPU and Memory on Postgres DB server and to the memory setting for the DB if needed.</p><p>4) Zabbix threads and queues. Zabbix uses various thread pools and queues to manage it's workload. If these cannot handle the load and queues fill, then zabbix stops functioning effectively, Tune the number of threads etc as required. The below diagram attempts to demonstrate.</p><p> </p><p>

<map id="gliffy-map-65499216-1791" name="gliffy-map-65499216-1791"></map>
<table width="100%" class="gliffy-macro-table">
    <tr>
        <td >
            <table class="gliffy-macro-inner-table">
                <caption align="bottom">
 </caption>

                <tr>
                    <td>
                        <img style="border: none; width: 1443px;" usemap="#gliffy-map-65499216-1791" src="attachments/25187155/65499217.png" alt="" class="gliffy-macro-image"/>
                    </td>
                </tr>
            </table>
 
        </td>
    </tr>
</table>


</p><p> </p><p>If Zabbix is having performance problems then check processes and caches from the right. If DB Syncers cannot write to the database fast enough, then the History Caches can fill, then the Pollers cannot offload data and get stuck, then everything stops.</p><p> </p>
                    </div>

                                        
                    
                 
                </div>             </div> 
            
        </div>     </body>
</html>
